# Apache HTTP Server security configuration
# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

# Server information disclosure
ServerTokens <%= @server_tokens %>
ServerSignature <%= @server_signature %>

# Disable TRACE HTTP method
TraceEnable <%= @trace_enable %>

# Disable directory browsing
<Directory />
    Options -Indexes
</Directory>

# Deny access to hidden files
<FilesMatch "^\.ht">
    Require all denied
</FilesMatch>

<FilesMatch "^\.(?!well-known\/).*">
    Require all denied
</FilesMatch>

# Disable CGI scripts in document root
<DirectoryMatch "^/var/www/(?!cgi-bin\/).*">
    <FilesMatch "\.(?i:cgi|pl|py|rb|sh)$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# Remove server version and operating system from error pages and server header
<IfModule mod_headers.c>
    Header unset Server
    Header unset X-Powered-By
    
    <% if @clickjacking_protection %>
    # Clickjacking protection
    Header always set X-Frame-Options "SAMEORIGIN"
    <% end %>
    
    <% if @xss_protection %>
    # XSS protection
    Header always set X-XSS-Protection "1; mode=block"
    <% end %>
    
    <% if @mime_sniffing_protection %>
    # MIME sniffing protection
    Header always set X-Content-Type-Options "nosniff"
    <% end %>
    
    <% if @content_security_policy %>
    # Content Security Policy
    Header always set Content-Security-Policy "<%= @content_security_policy %>"
    <% end %>
    
    # MIME type hardening
    AddDefaultCharset UTF-8
    AddCharset UTF-8 .js .css .xml .json .html .htm
</IfModule>

# Disable ETag for performance and privacy
FileETag None

# Limit request size to prevent abuse
LimitRequestBody 10485760

# Limit request fields to prevent DoS
LimitRequestFields 100
LimitRequestFieldSize 8190
LimitRequestLine 8190

# Disable server-side includes and CGI by default
Options -Includes -ExecCGI

# Set secure cookie flags
<IfModule mod_headers.c>
    Header edit Set-Cookie ^(.*) $1;HttpOnly;Secure
</IfModule>

# Disable HTTP 1.0 protocol
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /.*\ HTTP/1\.0$
    RewriteRule .* - [F]
</IfModule>

# Use UTF-8 encoding
AddDefaultCharset utf-8

# Limit methods to only what's needed
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} !^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$
    RewriteRule .* - [F]
</IfModule>

# Disable access to sensitive files
<FilesMatch "(phpunit|composer)\.(xml|lock|json)$">
    Require all denied
</FilesMatch>

<FilesMatch "^(package|composer|bower)\.json$">
    Require all denied
</FilesMatch>

<FilesMatch "^\.git">
    Require all denied
</FilesMatch>

<FilesMatch "\.(bak|config|sql|fla|ini|log|sh|inc|swp)$">
    Require all denied
</FilesMatch>

# Disable access to certain directories
<DirectoryMatch "/(\.git|cache|bin|logs|backup|tests)/|^/(\.settings|\.project|\.buildpath|composer\.|Dockerfile|docker-compose)">
    Require all denied
</DirectoryMatch>

# Modern TLS only in SSL VirtualHosts
SSLOptions +StrictRequire
SSLProtocol -all +TLSv1.2 +TLSv1.3