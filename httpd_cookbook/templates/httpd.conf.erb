# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.
#
# Apache HTTP Server main configuration file
ServerRoot <%= @server_root %>

<% @listen.each do |listen_line| %>
Listen <%= listen_line %>
<% end %>

# Base modules
<% if @mpm == 'event' %>
LoadModule mpm_event_module <%= @modules_path %>/mod_mpm_event.so
<% elsif @mpm == 'worker' %>
LoadModule mpm_worker_module <%= @modules_path %>/mod_mpm_worker.so
<% else %>
LoadModule mpm_prefork_module <%= @modules_path %>/mod_mpm_prefork.so
<% end %>

# Include module configurations
<% if File.directory?(@mod_dir) %>
Include <%= @mod_dir %>/*.load
<% end %>

# Global configuration
ServerAdmin <%= @server_admin %>
ServerName <%= @server_name %>

# User and group the server runs as
User <%= @user %>
Group <%= @group %>

# Default timeout
Timeout <%= @timeout %>

# KeepAlive settings
KeepAlive <%= @keep_alive %>
MaxKeepAliveRequests <%= @max_keep_alive_requests %>
KeepAliveTimeout <%= @keep_alive_timeout %>

# MPM Configuration
<% if @mpm == 'event' %>
<IfModule mpm_event_module>
    StartServers           <%= @mpm_config['start_servers'] %>
    MinSpareThreads        <%= @mpm_config['min_spare_threads'] %>
    MaxSpareThreads        <%= @mpm_config['max_spare_threads'] %>
    ThreadLimit            <%= @mpm_config['thread_limit'] %>
    ThreadsPerChild        <%= @mpm_config['threads_per_child'] %>
    MaxRequestWorkers      <%= @mpm_config['max_request_workers'] %>
    MaxConnectionsPerChild <%= @mpm_config['max_connections_per_child'] %>
</IfModule>
<% elsif @mpm == 'worker' %>
<IfModule mpm_worker_module>
    StartServers           <%= @mpm_config['worker']['start_servers'] %>
    MinSpareThreads        <%= @mpm_config['worker']['min_spare_threads'] %>
    MaxSpareThreads        <%= @mpm_config['worker']['max_spare_threads'] %>
    ThreadLimit            <%= @mpm_config['worker']['thread_limit'] %>
    ThreadsPerChild        <%= @mpm_config['worker']['threads_per_child'] %>
    MaxRequestWorkers      <%= @mpm_config['max_request_workers'] %>
    MaxConnectionsPerChild <%= @mpm_config['max_connections_per_child'] %>
</IfModule>
<% else %>
<IfModule mpm_prefork_module>
    StartServers           <%= @mpm_config['prefork']['start_servers'] %>
    MinSpareServers        <%= @mpm_config['prefork']['min_spare_servers'] %>
    MaxSpareServers        <%= @mpm_config['prefork']['max_spare_servers'] %>
    ServerLimit            <%= @mpm_config['prefork']['server_limit'] %>
    MaxRequestWorkers      <%= @mpm_config['prefork']['max_clients'] %>
    MaxConnectionsPerChild <%= @mpm_config['prefork']['max_requests_per_child'] %>
</IfModule>
<% end %>

# HTTP/2 support
<% if @enable_http2 %>
<IfModule mod_http2.c>
    Protocols h2 h2c http/1.1
    H2Direct on
</IfModule>
<% end %>

# Server tokens and signature settings
ServerTokens <%= @server_tokens %>
ServerSignature <%= @server_signature %>
TraceEnable <%= @trace_enable %>

# Logging
LogLevel <%= @log_level %>
ErrorLog <%= @error_log %>
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent
LogFormat "{\"time\":\"%t\",\"remoteIP\":\"%a\",\"host\":\"%V\",\"request\":\"%U\",\"query\":\"%q\",\"method\":\"%m\",\"status\":\"%>s\",\"userAgent\":\"%{User-agent}i\",\"referer\":\"%{Referer}i\",\"requestTime\":\"%D\"}" json

CustomLog <%= @access_log %> combined

# Default document directory
DocumentRoot "<%= @document_root %>"
<Directory "<%= @document_root %>">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Default directory index
DirectoryIndex <%= @directory_index %>

# Deny access to the filesystem
<Directory />
    AllowOverride none
    Require all denied
</Directory>

# Files and .htaccess files
<Files ".ht*">
    Require all denied
</Files>

# Mime types
TypesConfig <%= @server_root %>/mime.types
AddType application/x-compress .Z
AddType application/x-gzip .gz .tgz
AddType text/html .shtml
AddOutputFilter INCLUDES .shtml

# Include enabled configurations
<% if File.directory?(@conf_enabled_dir) %>
Include <%= @conf_enabled_dir %>/*.conf
<% end %>

<% if @additional_config && !@additional_config.empty? %>
# Additional custom configuration
<% @additional_config.each do |key, value| %>
<%= key %> <%= value %>
<% end %>
<% end %>