# Monitoring Configuration
# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

# Load the status module if not already loaded
<IfModule !mod_status.c>
    LoadModule status_module modules/mod_status.so
</IfModule>

# ExtendedStatus provides more information but at a performance cost
ExtendedStatus On

# Configure the status module
<Location "<%= @status_path %>">
    SetHandler server-status
    
    <% if @restricted_access %>
    # Restrict access to specific IPs
    Require ip <%= @allowed_ips.join(' ') %>
    <% else %>
    # Allow from anywhere - not recommended for production!
    Require all granted
    <% end %>
</Location>

# Enable server status reporting for monitoring
<IfModule mod_status.c>
    # Enable extended status
    ExtendedStatus On
    
    # Configure mod_info if available
    <IfModule mod_info.c>
        <Location "/server-info">
            SetHandler server-info
            <% if @restricted_access %>
            # Restrict access to specific IPs
            Require ip <%= @allowed_ips.join(' ') %>
            <% else %>
            # Allow from anywhere - not recommended for production!
            Require all granted
            <% end %>
        </Location>
    </IfModule>
    
    # Configure a plain text status output for monitoring tools
    <Location "/server-status-plain">
        SetHandler server-status
        <% if @restricted_access %>
        # Restrict access to specific IPs
        Require ip <%= @allowed_ips.join(' ') %>
        <% else %>
        # Allow from anywhere - not recommended for production!
        Require all granted
        <% end %>
        
        # Force plain text format
        ForceType text/plain
    </Location>
    
    # Configure a JSON status output for monitoring tools
    <Location "/server-status-json">
        SetHandler server-status
        <% if @restricted_access %>
        # Restrict access to specific IPs
        Require ip <%= @allowed_ips.join(' ') %>
        <% else %>
        # Allow from anywhere - not recommended for production!
        Require all granted
        <% end %>
        
        # Set content type to JSON
        ForceType application/json
        
        # Use mod_substitute to transform HTML into JSON
        AddOutputFilterByType SUBSTITUTE application/json
        Substitute "s|.*|{\"status\":\"OK\"}|n"
    </Location>
</IfModule>