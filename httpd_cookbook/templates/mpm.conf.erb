# MPM Configuration
# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

# MPM: <%= @mpm %>

<% if @mpm == 'event' %>
<IfModule mpm_event_module>
    # Event MPM settings
    # These settings are optimized for <%= node['platform_family'] %> running on <%= node['cpu']['total'] %> cores
    
    # Start with a set number of server processes
    StartServers             <%= @start_servers %>
    
    # Keep a minimum and maximum number of spare threads available
    MinSpareThreads          <%= @min_spare_threads %>
    MaxSpareThreads          <%= @max_spare_threads %>
    
    # Thread limits
    ThreadLimit              <%= @thread_limit %>
    ThreadsPerChild          <%= @threads_per_child %>
    
    # Maximum number of connections that will be processed simultaneously
    MaxRequestWorkers        <%= @max_request_workers %>
    
    # Maximum number of connections a child process will serve before terminating
    MaxConnectionsPerChild   <%= @max_connections_per_child %>
    
    # Asynchronous connection mode for higher throughput
    AsyncRequestWorkerFactor 2
</IfModule>
<% elsif @mpm == 'worker' %>
<IfModule mpm_worker_module>
    # Worker MPM settings
    # These settings are optimized for <%= node['platform_family'] %> running on <%= node['cpu']['total'] %> cores
    
    # Start with a set number of server processes
    StartServers             <%= @worker_start_servers %>
    
    # Keep a minimum and maximum number of spare threads available
    MinSpareThreads          <%= @worker_min_spare_threads %>
    MaxSpareThreads          <%= @worker_max_spare_threads %>
    
    # Thread limits
    ThreadLimit              <%= @worker_thread_limit %>
    ThreadsPerChild          <%= @worker_threads_per_child %>
    
    # Server process limits
    ServerLimit              <%= @worker_server_limit %>
    
    # Maximum number of connections that will be processed simultaneously
    MaxRequestWorkers        <%= @max_request_workers %>
    
    # Maximum number of connections a child process will serve before terminating
    MaxConnectionsPerChild   <%= @max_connections_per_child %>
</IfModule>
<% else %>
<IfModule mpm_prefork_module>
    # Prefork MPM settings
    # These settings are optimized for <%= node['platform_family'] %> running on <%= node['cpu']['total'] %> cores
    
    # Start with a set number of server processes
    StartServers             <%= @prefork_start_servers %>
    
    # Keep a minimum and maximum number of spare server processes available
    MinSpareServers          <%= @prefork_min_spare_servers %>
    MaxSpareServers          <%= @prefork_max_spare_servers %>
    
    # Server process limits
    ServerLimit              <%= @prefork_server_limit %>
    
    # Maximum number of connections that will be processed simultaneously
    MaxRequestWorkers        <%= @prefork_max_clients %>
    
    # Maximum number of requests a process will serve before terminating
    MaxConnectionsPerChild   <%= @prefork_max_requests_per_child %>
</IfModule>
<% end %>

# Timeout and KeepAlive settings for the selected MPM
<IfModule <%= @mpm %>_module>
    # Connection timeout
    Timeout                  <%= @timeout || 300 %>
    
    # KeepAlive settings
    KeepAlive                <%= @keep_alive || 'On' %>
    MaxKeepAliveRequests     <%= @max_keep_alive_requests || 100 %>
    KeepAliveTimeout         <%= @keep_alive_timeout || 5 %>
</IfModule>

# Additional MPM tuning
<IfModule <%= @mpm %>_module>
    # Prevent Slowloris DOS attack by setting an appropriate timeout
    RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
    
    # Set maximum request sizes
    LimitRequestBody         10485760
    LimitRequestFields       100
    LimitRequestFieldSize    8190
    LimitRequestLine         8190
    
    # Disable Accept Filters
    AcceptFilter http none
    AcceptFilter https none
</IfModule>